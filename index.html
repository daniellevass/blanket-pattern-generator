<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Blanket Pattern Generator</title>
</head>
<body>
  <p>
   height = <input type="number" id="txtHeight" value="5"></input>
   width = <input type="number" id="txtWidth" value="5"></input></p>
   <p>Colours (in hex, seperated by comma, minimum 4)</p>
   <p><input type="text" style="width:50%;" id="txtColours" value="#AAB2BD,#E6E9ED,#656D78,#2a7286,#d05331"></input></p>
   <p><button onclick="javascript:makeBlanket();">make!</button></p>
   <div id="container_totals">

     <svg height="20" width="1000">
     </svg>

   </div>
   <div id="container_canvas"></div>

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
<script>

function calculateColour(x,y){
  // console.log('calculate colour = ' + x + "," + y)
  var found = false;
  var tries = 50;
  while (!found
    && tries > 0){

    var colour = colours[Math.floor(Math.random() * colours.length) + 0];
    tries --;

    //check it's not the same as the colour to the left
    var colourLeft = matrix[y][x-1];
    if (colourLeft) {
      if (colourLeft == colour) {
        continue;
      }
    }

    //check it's not the same as above
    if (y > 0){
      var colourTop = matrix[y-1][x];
      if (colourTop) {
        if (colourTop == colour) {
          continue;
        }
      }

      if (x >0) {
        var colourTopLeft = matrix[y-1][x-1];
        if (colourTopLeft) {
          if (colourTopLeft == colour) {
            continue;
          }
        }
      }

      if (x < numberX) {
        var colourTopRight = matrix[y-1][x+1];
        if (colourTopRight) {
          if (colourTopRight == colour) {
            continue;
          }
        }
      }

    }

      // console.log(colour + "=" +colourAllocations[colour]);

      if (colourAllocations[colour] > 0){
        colourAllocations[colour] --;
        found = true;
         matrix[y][x] = colour;
        return colour;
      }
  }

}

function calculateColour_v2(x,y) {

    // get the colours around
    var usedColours = new Set();
    usedColours.add(matrix[y][x-1]) // left circle

    if (y > 0) {
      usedColours.add(matrix[y-1][x]); // top circle

      // if we're on row 1 (second row) -> we need to check top and top left
      if(y % 2 == 0) {


        if (x < numberX) {
          usedColours.add(matrix[y-1][x+1])
        }
      } else {
        // if we're row 2 (third row) -> we need to check top and top right
        if (x > 0) {
          usedColours.add(matrix[y-1][x-1]) // top left circle
        }
      }

    }

    // using the colours around create an an array of colours not around
    var coloursICanUse = []
    for (let i in colours) {
      let colour = colours[i]
      if (! usedColours.has(colour)) {
        coloursICanUse.push(colour)
      }
    }

  var newColour = coloursICanUse[Math.floor(Math.random() * coloursICanUse.length) + 0];
  matrix[y][x] = newColour;
  return newColour;

}

function drawIndividualCircle(x, y, offset) {
  // console.log("draw individual circle = " + x + "," +y)
  var circle = paper.circle(50 + offset + (x*50), 50 + (y*45), 25);
  circle.attr("fill", calculateColour_v2(x,y));
  // console.log("got colour for circle =  " + x + "," +y);
  circle.attr("stroke-width", "0");
}

function drawRowCircles(y, number, offset){
  // console.log("drawing row circles = " + y);
  for (var i = 0; i < number; i++){
    drawIndividualCircle(i, y, offset)
  }
}

function drawAllCircles(){
  console.log("drawing all circles");
  for (var i = 0; i < numberY; i ++){
    matrix[i] = [];
    if(i % 2){
      drawRowCircles(i, numberX, 0);
    } else {
      drawRowCircles(i, numberX, 25);
    }
  }
}

var paper;
var numberX; //number of circles width
var numberY; //number of circles height
var colours;
var numOfEachColour; //number of circles for each colour
var colourAllocations = []; //allocation of total number of colours (prevents everything being 1 colour)
var matrix = [];


  function validateInputs(){
    console.log($("#txtWidth").val());
    console.log($("#txtHeight").val());

    //validate inputs
    if (!$("#txtWidth").val()
        || $("#txtWidth").val().length == 0
        || isNaN($("#txtWidth").val()) ) {
          console.log("width not valid");
          return false;
    }

    if (!$("#txtHeight").val()
        || $("#txtHeight").val().length == 0
        || isNaN($("#txtHeight").val()) ) {
          console.log("height not valid");
          return false;
    }

    if (!$("#txtColours").val()
        || $("#txtColours").val().length == 0) {
          console.log("colour input not valid");
        return false;
    }

    return true;

  }

  function makeBlanket(){

    if (!validateInputs()) {
      console.log("inputs not valid!");
      return false;
    }

    var coloursEntry = $("#txtColours").val().split(",");
    console.log("colours entry = " + coloursEntry.length);
    if (coloursEntry.length < 4) {
      console.log("colours not valid :(");
      return false;
    }

     paper.remove();

     numberX = $("#txtWidth").val();
     numberY = $("#txtHeight").val();

     paper = Raphael(document.getElementById('container_canvas'), (numberX * 50) + 150, (numberY * 50) + 150);


     colours = coloursEntry;
     numOfEachColour = Math.ceil( (numberX * numberY) / colours.length);

     console.log("number of each colour = " + numOfEachColour);

     for (var index in colours){
         colourAllocations[colours[index]] = numOfEachColour;
     }

     drawAllCircles();

  }


function makeStarterBlanket(){
    numberX = 16;
    numberY = 8;

    paper = Raphael(document.getElementById('container_canvas'), (numberX * 50) + 150, (numberY * 50) + 150);


    colours = ["#AAB2BD", "#E6E9ED", "#656D78", "#2a7286", "#d05331", "#c6c88a"];
    numOfEachColour = Math.ceil( (numberX * numberY) / colours.length);

    for (var index in colours){
        colourAllocations[colours[index]] = numOfEachColour;
    }

    drawAllCircles();
}

  makeStarterBlanket();
</script>
</html>
